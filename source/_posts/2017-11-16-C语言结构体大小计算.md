---
title: C语言结构体大小计算
categories:
  - struggle
tags:
  - C
date: 2017-11-16 14:23:00
---

## 前言

在使用C语言进行数据结构的实现时，结构体会被普遍使用到，但是对于结构体大小的计算一直有点疑问，这里进行学习与解释一下。

<!-- more -->

## 字节大小

由于结构体中可以定义不同类型变量，所以计算结构体的大小与其中定义到的变量类型有关，因此有必要了解一下C语言各类型大小，单位为字节。

| Type           | Size x64 | Size x32 |
| -------------- | -------- | -------- |
| char           | 1        | 1        |
| short          | 2        | 2        |
| int            | 4        | 4        |
| short int      | 2        | 2        |
| unsigned int   | 4        | 4        |
| long           | 8        | 4        |
| unsigned long  | 8        | 4        |
| float          | 4        | 4        |
| double         | 8        | 8        |
| int *          | 8        | 4        |

这里要注意的是所有的***指针***变量其大小都统一，和定义的具体类型无关。

## 偏移量

### 定义

> 结构体中的偏移量是一个成员的实际地址和结构体首地址之间的距离。

### 规则

1. 每个成员的偏移量必须是当前成员所占内存大小的整数倍，如果不是编译器会在成员之间加上填充字节。
2. 当所有成员大小计算完毕，编译器会判断当前结构体大小是否是结构体中最宽成员变量大小的整数倍，如果不是则会在最后一个成员后面填充字节。

## 计算

在这里通过实例解释一下，需要注意的是以64位编译器作为平台。

### 成员间填充字节

```c
struct node {
  int data;
  struct node *pNext;
} Node;
```

解释如下：

1. int data: 偏移量为0，大小为4
2. struct node *pNext: 偏移量为4，指针变量大小为8，偏移量应为变量大小的整数倍，所以在成员之间填充4字节，变为偏移量8，大小8
3. 当前结构体大小为4 + 4 + 8 = 16，是结构体内最宽成员指针变量大小8的整数倍

结果为16字节，计算为4 + 4（填充） + 8 = 16。

### 末尾填充字节

```c
struct node {
  struct node *pNext;
  int data;
} Node;
```

解释如下：

1. struct node *pNext: 偏移量为0，指针变量大小为8
2. int data: 偏移量为8，大小为4
3. 当前结构体大小为8 + 4 = 12，不是8的整数倍，在int data之后填充4字节，

结果为16字节8 + 4 + 4（填充） = 16。
